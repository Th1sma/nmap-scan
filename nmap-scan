#!/usr/bin/env python3
import os
import subprocess
import argparse
import sys
import xml.etree.ElementTree as ET
from datetime import datetime

# Configuration des profils de scan
SCAN_PROFILES = {
    "quick": {
        "args": "-sV -sC -A -T4",
        "desc": "Scan standard (1 000 ports) avec d√©tection d'OS, services et scripts par d√©faut."
    },
    "full": {
        "args": "-p- -sV -sC -A -T4",
        "desc": "Scan exhaustif de tous les ports (65535), d√©tection compl√®te et scripts."
    },
    "stealth": {
        "args": "-sS -Pn -f -T2",
        "desc": "Scan furtif (SYN scan, fragmentation, vitesse lente) sans ping."
    }
}

def print_banner():
    banner = r"""
  _   _                      ____                      
 | \ | |_ __ ___   __ _ _ __/ ___|  ___ __ _ _ __      
 |  \| | '_ ` _ \ / _` | '_ \___ \ / __/ _` | '_ \     
 | |\  | | | | | | (_| | |_) |__) | (_| (_| | | | |    
 |_| \_|_| |_| |_|\__,_| .__/____/ \___\__,_|_| |_|    
                       |_|                             
    --- Outil de scan de port ---
    """
    print(banner)

# Ex√©cution des scans Nmap selon le profil choisi
def run_nmap(target, mode):
    """Ex√©cute nmap et retourne le chemin du fichier XML g√©n√©r√©."""
    timestamp = datetime.now().strftime("%Y%m%d_%H%M")
    output_xml = f"reports/scan_{target.replace('.', '_')}_{timestamp}.xml"
    
    nmap_cmd = f"nmap {SCAN_PROFILES[mode]['args']} -oX {output_xml} {target}"
    
    print(f"[*] Mode : {mode.upper()}")
    print(f"[*] Cible : {target}")
    print(f"[*] Lancement de Nmap...\n")
    
    try:
        # Shell=True pour la simplicit√© de la commande
        subprocess.run(nmap_cmd, shell=True, check=True)
        return output_xml
    except subprocess.CalledProcessError:
        print("\n‚ùå Erreur : Nmap a √©chou√©. V√©rifie tes droits (sudo requis pour stealth).")
        sys.exit(1)

# Construction du rapport Markdown √† partir du XML
def build_report(xml_path, target, mode):
    """Analyse le XML et g√©n√®re un rapport incluant TOUS les ports sans distinction d'√©tat."""
    md_path = xml_path.replace(".xml", ".md")
    
    try:
        tree = ET.parse(xml_path)
        root = tree.getroot()
        
        # Extraction de l'OS global (si d√©tect√©)
        detected_os = "Non identifi√©"
        os_match = root.find(".//osmatch")
        if os_match is not None:
            detected_os = os_match.get('name')
        else:
            service_info = root.find(".//service")
            if service_info is not None and service_info.get('ostype'):
                detected_os = service_info.get('ostype')

        with open(md_path, "w", encoding="utf-8") as f:
            f.write(f"# Rapport de Scan : {target}\n\n")
            f.write(f"- **Date** : {datetime.now().strftime('%d/%m/%Y %H:%M')}\n")
            f.write(f"- **Profil** : {mode.upper()}\n")
            f.write(f"- **OS d√©tect√©** : `{detected_os}`\n\n")
            
            f.write("## üìù R√©sultats de l'analyse des ports\n\n")
            f.write("| Port | Protocole | √âtat | Service | Version | Info OS |\n")
            f.write("| :--- | :--- | :--- | :--- | :--- | :--- |\n")
            
            # On boucle sur TOUS les ports list√©s dans le XML
            for port in root.findall(".//port"):
                port_id = port.get('portid')
                proto = port.get('protocol')
                
                # R√©cup√©ration de l'√©tat (open, closed, etc.)
                state_node = port.find('state')
                state = state_node.get('state') if state_node is not None else "unknown"
                
                # R√©cup√©ration des informations de service
                service_tag = port.find('service')
                service = "N/A"
                full_version = "N/A"
                port_os = detected_os
                
                if service_tag is not None:
                    service = service_tag.get('name', 'N/A')
                    product = service_tag.get('product', '')
                    version = service_tag.get('version', '')
                    full_version = f"{product} {version}".strip() or "N/A"
                    if service_tag.get('ostype'):
                        port_os = service_tag.get('ostype')

                # √âcriture de la ligne dans le tableau
                f.write(f"| {port_id} | {proto} | {state} | {service} | {full_version} | {port_os} |\n")
        
        return md_path
    except Exception as e:
        print(f"‚ùå Erreur lors de la g√©n√©ration du rapport : {e}")
        sys.exit(1)

# Main
if __name__ == "__main__":
    print_banner()
    
    parser = argparse.ArgumentParser(description="nmap-scan : Scanner de port.")
    parser.add_argument("target", help="IP ou domaine √† scanner")
    parser.add_argument("-m", "--mode", choices=SCAN_PROFILES.keys(), default="quick", 
                        help="Mode de scan (quick, full, stealth)")
    
    args = parser.parse_args()
    
    # Cr√©ation du dossier reports si inexistant
    if not os.path.exists("reports"):
        os.makedirs("reports")

    # Workflow
    xml_file = run_nmap(args.target, args.mode)
    md_file = build_report(xml_file, args.target, args.mode)
    
    # Nettoyage
    if os.path.exists(xml_file):
        os.remove(xml_file)
    print(f"\n[+] Travail termin√©. Les rapports sont dans le dossier 'reports/'.")